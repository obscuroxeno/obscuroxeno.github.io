<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HTML Injection Visualizer</title>
    <style>
/* --- Global Styles --- */
body {
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
    background-color: #f0f4f8;
    color: #333;
    margin: 0;
    padding: 20px;
    line-height: 1.6;
}

h1, h2, h3 {
    color: #1a237e;
    margin-top: 0;
}
h2 {
    border-bottom: 2px solid #e0e0e0;
    padding-bottom: 8px;
}

pre {
    background: #2d2d2d;
    color: #f1f1f1;
    padding: 10px;
    border-radius: 5px;
    white-space: pre-wrap;
    word-wrap: break-word;
    font-family: "Courier New", Courier, monospace;
    font-size: 14px;
}
pre .tag { color: #569cd6; }
pre .attr { color: #9cdcfe; }
pre .str { color: #ce9178; }
pre .txt { color: #d4d4d4; }

/* --- Header & Toggle --- */
header {
    max-width: 1200px;
    margin: 0 auto 20px auto;
    background: #fff;
    padding: 20px;
    border-radius: 8px;
    box-shadow: 0 4px 10px rgba(0,0,0,0.05);
    text-align: center;
}

.mode-toggle-bar {
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 15px;
    font-weight: 500;
    margin-top: 15px;
    color: #555;
}

.mode-banner {
    padding: 10px;
    border-radius: 5px;
    font-weight: bold;
    margin-top: 15px;
    display: none;
}
.mode-banner.unsafe {
    background-color: #ffebee;
    color: #c62828;
    border: 1px solid #c62828;
    display: block;
    animation: fadeIn 0.3s;
}
.mode-banner.safe {
    background-color: #e8f5e9;
    color: #2e7d32;
    border: 1px solid #2e7d32;
    display: block;
    animation: fadeIn 0.3s;
}

/* --- Toggle Switch Styles --- */
.switch { position: relative; display: inline-block; width: 60px; height: 34px; }
.switch input { opacity: 0; width: 0; height: 0; }
.slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #c62828; transition: .4s; }
.slider:before { position: absolute; content: ""; height: 26px; width: 26px; left: 4px; bottom: 4px; background-color: white; transition: .4s; }
input:checked + .slider { background-color: #2e7d32; }
input:checked + .slider:before { transform: translateX(26px); }
.slider.round { border-radius: 34px; }
.slider.round:before { border-radius: 50%; }

/* --- Main Layout --- */
.visualizer-container {
    display: flex;
    max-width: 1200px;
    margin: 0 auto;
    background: #ffffff;
    border-radius: 8px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.05);
    overflow: hidden;
}

.panel {
    flex: 1;
    padding: 25px;
}
#input-panel {
    border-right: 1px solid #e0e0e0;
}

/* --- Left Panel --- */
textarea#html-input {
    width: 97%;
    height: 120px;
    border: 1px solid #ccc;
    border-radius: 5px;
    padding: 10px;
    font-family: "Courier New", Courier, monospace;
    font-size: 14px;
    margin-bottom: 10px;
}

.examples { display: flex; gap: 10px; margin-bottom: 20px; }
.example-btn {
    flex: 1;
    background-color: #f0f0f0;
    color: #555;
    border: 1px solid #ddd;
    padding: 8px;
    font-size: 12px;
    cursor: pointer;
    border-radius: 4px;
    transition: background-color 0.2s;
}
.example-btn:hover { background-color: #e0e0e0; }

#post-button {
    width: 100%;
    background-color: #1976d2;
    color: white;
    border: none;
    padding: 12px 20px;
    border-radius: 5px;
    cursor: pointer;
    font-size: 16px;
    font-weight: 500;
    transition: background-color 0.3s;
}
#post-button:hover { background-color: #1565c0; }
#post-button:disabled {
    background-color: #9e9e9e;
    cursor: not-allowed;
}

.output-box {
    min-height: 100px;
    background: #fafafa;
    border: 1px solid #ddd;
    border-radius: 5px;
    padding: 15px;
    margin-top: 10px;
    word-wrap: break-word;
}

/* --- Right Panel (Animation) --- */
#flow-container {
    display: flex;
    flex-direction: column;
    gap: 15px;
}
.flow-placeholder {
    text-align: center;
    color: #777;
    padding: 40px 20px;
}
.flow-placeholder h3 { color: #1976d2; }

.flow-step {
    background: #fff;
    border: 1px solid #e0e0e0;
    border-radius: 8px;
    padding: 15px 20px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.03);
    opacity: 0;
    transform: translateY(10px);
    animation: fadeIn 0.5s ease-out forwards;
}

@keyframes fadeIn {
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.network-flow {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 20px;
    font-size: 32px;
    padding: 10px 0;
}
.network-flow .arrow {
    width: 50%;
    height: 4px;
    background: #1976d2;
    position: relative;
}
.network-flow .arrow::after {
    content: '';
    position: absolute;
    right: -2px;
    top: -6px;
    border: 8px solid transparent;
    border-left-color: #1976d2;
}
.network-flow .arrow::before {
    content: '';
    position: absolute;
    left: 0;
    top: -2px;
    width: 8px;
    height: 8px;
    background: #fff;
    border-radius: 50%;
    animation: flow 2s linear infinite;
}
@keyframes flow {
    0% { left: 0; }
    100% { left: calc(100% - 8px); }
}

.dom-tree {
    background: #fafafa;
    border: 1px solid #eee;
    padding: 15px;
    border-radius: 5px;
    font-family: "Courier New", Courier, monospace;
    font-size: 14px;
}
.dom-tree .node {
    padding-left: 20px;
    position: relative;
}
.dom-tree .node::before {
    content: '';
    position: absolute;
    left: 5px;
    top: 8px;
    height: 1px;
    width: 10px;
    background: #999;
}
.dom-tree .text-node { color: #388e3c; }
.dom-tree .element-node { color: #c62828; }

.final-render-box {
    background: #f9f9f9;
    border: 1px solid #ddd;
    padding: 10px;
    border-radius: 4px;
    min-height: 40px;
}

/* --- Explainer Panel --- */
.explainer-container {
    max-width: 1200px;
    margin: 20px auto;
    background: #fff;
    padding: 25px;
    border-radius: 8px;
    box-shadow: 0 4px 10px rgba(0,0,0,0.05);
    display: none;
}
#explainer-content h4 {
    margin-top: 0;
    font-size: 1.2em;
}
#explainer-content p {
    margin-bottom: 10px;
}
#explainer-content code {
    background: #eee;
    padding: 2px 5px;
    border-radius: 3px;
    font-family: "Courier New", Courier, monospace;
}
    </style>
</head>
<body>

    <header>
        <h1>HTML Injection Visualizer</h1>
        <p>See how HTML injection affects the DOM in real-time.</p>
        <div class="mode-toggle-bar">
            <span>Unsafe Mode (innerHTML)</span>
            <label class="switch">
                <input type="checkbox" id="mode-toggle">
                <span class="slider round"></span>
            </label>
            <span>Safe Mode (textContent)</span>
        </div>
        <div id="mode-banner" class="mode-banner"></div>
    </header>

    <div class="visualizer-container">
        
        <div class="panel" id="input-panel">
            <h2>User Input</h2>
            <textarea id="html-input" placeholder="e.g., <span style='color:red;'>Red Text</span>"></textarea>
            
            <div class="examples">
                <button class="example-btn" data-value="<span style='color:red; font-weight:bold;'>Red Text</span>">Example 1</button>
                <button class="example-btn" data-value="<img src=x onerror=alert('XSS Attack!')>">Example 2</button>
                <button class="example-btn" data-value="<svg onload=alert('SVG Attack!')>">Example 3</button>
            </div>
            
            <button id="post-button">Post Message</button>

            <h2>Final Rendered Output:</h2>
            <div id="output-display" class="output-box">
                </div>
        </div>

        <div class="panel" id="visual-flow-panel">
            <h2>Visual Flow</h2>
            <div id="flow-container">
                <div class="flow-placeholder">
                    <svg width="64" height="64" viewBox="0 0 24 24" style="fill: #1976d2;">
                        <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 15v-5H9v-2h2V9h2v1h2v2h-2v5h-2z"></path>
                    </svg>
                    <h3>Ready to Learn!</h3>
                    <p>Enter some text in the left panel and click "Post Message" to see the magic happen.</p>
                </div>
            </div>
        </div>
    </div>

    <div class="explainer-container" id="explainer">
        <h2>What Just Happened?</h2>
        <div id="explainer-content">
            </div>
    </div>

    <script>
document.addEventListener('DOMContentLoaded', () => {
    // --- Get all the HTML elements ---
    const modeToggle = document.getElementById('mode-toggle');
    const modeBanner = document.getElementById('mode-banner');
    const htmlInput = document.getElementById('html-input');
    const postButton = document.getElementById('post-button');
    const outputDisplay = document.getElementById('output-display');
    const flowContainer = document.getElementById('flow-container');
    const explainerContainer = document.getElementById('explainer');
    const explainerContent = document.getElementById('explainer-content');
    const exampleBtns = document.querySelectorAll('.example-btn');
    const initialFlowContent = flowContainer.innerHTML;

    let isSafeMode = false;

    // --- Helper function for delays ---
    const delay = (ms) => new Promise(res => setTimeout(res, ms));

    // --- Helper function to sanitize text for display ---
    const escapeHTML = (str) => {
        return str.replace(/&/g, '&amp;')
                  .replace(/</g, '<')
                  .replace(/>/g, '>')
                  .replace(/"/g, '"')
                  .replace(/'/g, '&#039;');
    };

    // --- Helper to syntax-highlight the code ---
    const highlight = (str) => {
        return escapeHTML(str)
            .replace(/(<[a-z\/]+)/g, '<span class="tag">$1</span>')
            .replace(/(\w+=)/g, '<span class="attr">$1</span>')
            .replace(/(&#039;.*?&#039;|quot;.*?quot;)/g, '<span class="str">$1</span>')
            + '<span class="tag">></span>';
    };

    // --- Toggle Switch Logic ---
    modeToggle.addEventListener('change', () => {
        isSafeMode = modeToggle.checked;
        updateModeUI();
    });

    function updateModeUI() {
        if (isSafeMode) {
            modeBanner.textContent = '‚úÖ Safe Mode Active (textContent)';
            modeBanner.className = 'mode-banner safe';
        } else {
            modeBanner.textContent = '‚ö†Ô∏è Unsafe Mode Active (innerHTML)';
            modeBanner.className = 'mode-banner unsafe';
        }
    }
    updateModeUI(); // Set initial state

    // --- Example Buttons Logic ---
    exampleBtns.forEach(btn => {
        btn.addEventListener('click', () => {
            htmlInput.value = btn.dataset.value;
        });
    });

    // --- Main "Post" Button Logic ---
    postButton.addEventListener('click', async () => {
        const userInput = htmlInput.value;
        if (!userInput) return;

        // Reset UI
        postButton.disabled = true;
        postButton.textContent = 'Processing...';
        flowContainer.innerHTML = '';
        explainerContainer.style.display = 'none';

        // Start the animation flow
        await runAnimationFlow(userInput);

        // Re-enable button
        postButton.disabled = false;
        postButton.textContent = 'Post Message';
    });

    // --- THE ANIMATION FLOW ---
    async function runAnimationFlow(userInput) {
        // Step 1: User Input
        addFlowStep(
            'Step 1: Browser - User Input Captured',
            `<p>The browser captures the raw text from the input field.</p>
             <pre>${highlight(userInput)}</pre>`
        );
        await delay(1500);

        // Step 1.5: HTTP POST Request
        const encodedInput = new URLSearchParams({ message: userInput }).toString();
        addFlowStep(
            'Step 1.5: HTTP POST Request',
            `<p>The browser encodes the text and sends it to the server in the body of a POST request.</p>
             <pre>POST /submit HTTP/1.1\nHost: example.com\nContent-Type: application/x-www-form-urlencoded\n\n${encodedInput}</pre>`
        );
        await delay(1000);
        addNetworkAnimation('Browser', 'Server');
        await delay(1500);

        // Step 2: Server Processing
        addFlowStep(
            'Step 2: Server Processing',
            `<p>The server receives the request, decodes the message, and (in this demo) stores it without any sanitization.</p>
             <pre>// Simple Node.js/Express example\nconst message = req.body.message;\n// ...save to database...\nres.json({ savedMessage: message });</pre>`
        );
        await delay(2000);

        // Step 2.5: HTTP Response
        addFlowStep(
            'Step 2.5: HTTP Response',
            `<p>The server sends the raw, saved message back to the browser to be displayed.</p>
             <pre>HTTP/1.1 200 OK\nContent-Type: application/json\n\n{"savedMessage": "${escapeHTML(userInput)}"}</pre>`
        );
        await delay(1000);
        addNetworkAnimation('Server', 'Browser');
        await delay(1500);

        // Step 3: Browser DOM Tree (The IMPORTANT difference)
        if (isSafeMode) {
            // --- SAFE MODE ---
            addFlowStep(
                'Step 3: Browser - DOM Tree Structure (Safe)',
                `<p>The browser is told to use <strong>.textContent</strong>. It creates a single <strong>#text node</strong> and inserts the raw string as literal text. HTML tags are NOT parsed.</p>
                 <div class="dom-tree">
                    <div><div id="output"></div>
                    <div class="node text-node">#text: "${escapeHTML(userInput)}"</div>
                 </div>`
            );
            await delay(2500);

            // Step 4: Safe Rendering
            addFlowStep(
                'Step 4: Safe Rendering (textContent)',
                `<p>The final output displays the literal text, exactly as it was typed. The HTML tags are rendered harmlessly.</p>
                 <div class="final-render-box">${escapeHTML(userInput)}</div>`
            );
            outputDisplay.textContent = userInput; // The actual "safe" render
            showExplainer(true, userInput);

        } else {
            // --- UNSAFE MODE ---
            addFlowStep(
                'Step 3: Browser - DOM Tree Structure (Unsafe)',
                `<p>The browser is told to use <strong>.innerHTML</strong>. It parses the string and creates new HTML elements in the DOM. This is the vulnerability!</p>
                 <div class="dom-tree">
                    <div><div id="output"></div>
                    ${generateDomTree(userInput)}
                 </div>`
            );
            await delay(2500);

            // Step 4: Unsafe Rendering
            addFlowStep(
                'Step 4: Unsafe Rendering (innerHTML)',
                `<p>The browser renders the new HTML. If the code is malicious (like an 'onerror' or 'onload' script), it will execute.</p>
                 <div class="final-render-box" id="unsafe-render-box"></div>`
            );
            // We set innerHTML here AFTER the box is created to avoid self-XSSing the tool page
            document.getElementById('unsafe-render-box').innerHTML = userInput;
            outputDisplay.innerHTML = userInput; // The actual "unsafe" render
            showExplainer(false, userInput);
        }
    }

    // --- Helper to add an animated card ---
    function addFlowStep(title, content) {
        const step = document.createElement('div');
        step.className = 'flow-step';
        step.innerHTML = `
            <h3>${title}</h3>
            ${content}
        `;
        flowContainer.appendChild(step);
        step.scrollIntoView({ behavior: 'smooth', block: 'end' });
    }

    // --- Helper for network diagram ---
    function addNetworkAnimation(from, to) {
        const fromIcon = (from === 'Browser') ? 'üíª' : 'üñ•Ô∏è';
        const toIcon = (to === 'Browser') ? 'üíª' : 'üñ•Ô∏è';
        const arrowClass = (from === 'Browser') ? 'arrow-right' : 'arrow-left';
        const content = `
            <div class="network-flow">
                <span>${fromIcon}</span>
                <div class="arrow"></div>
                <span>${toIcon}</span>
            </div>
            <p style="text-align:center; font-size: 12px; color: #555;">Data traveling over HTTP...</p>
        `;
        addFlowStep(`${from} ‚ûî ${to}`, content);
    }
    
    // --- Helper to show DOM tree (simple version) ---
    function generateDomTree(html) {
        try {
            const parser = new DOMParser();
            const doc = parser.parseFromString(html, 'text/html');
            let tree = '';
            doc.body.childNodes.forEach(node => {
                if (node.nodeType === 3) { // Text node
                    if (node.textContent.trim()) {
                        tree += `<div class="node text-node">#text: "${escapeHTML(node.textContent)}"</div>`;
                    }
                } else if (node.nodeType === 1) { // Element node
                    tree += `<div class="node element-node"><${node.tagName.toLowerCase()}></div>`;
                    if (node.childNodes.length > 0) {
                         tree += `<div class="node text-node" style="margin-left: 20px;">#text: "${escapeHTML(node.textContent)}"</div>`
                    }
                }
            });
            return tree;
        } catch (e) {
            return `<div class="node text-node">"${escapeHTML(html)}"</div>`;
        }
    }

    // --- Helper to show the final explanation text ---
    function showExplainer(safe, userInput) {
        explainerContainer.style.display = 'block';
        if (safe) {
            explainerContent.innerHTML = `
                <h4>Safe Mode Explanation (textContent)</h4>
                <p>The browser was instructed to use <strong>.textContent</strong>. This property tells the browser to treat the *entire* string as plain text.</p>
                <p>As you saw in the DOM Tree, the browser created a single <strong>#text node</strong>. All the HTML tags like <code><span></code> were not interpreted as HTML, but were instead rendered as literal text.</p>
                <p><strong>This is the correct way to render user-provided text and prevents HTML Injection and Cross-Site Scripting (XSS).</strong></p>
            `;
        } else {
            explainerContent.innerHTML = `
                <h4>Unsafe Mode Explanation (innerHTML)</h4>
                <p>The browser was instructed to use <strong>.innerHTML</strong>. This dangerous property tells the browser to parse the string *as HTML code*.
                <p>As you saw in the DOM Tree, the browser found the <code><span></code> tag and created a new <strong>HTML element</strong>. If the input had been <code><script></code> or <code><img onerror="..."></code>, the browser would have executed that malicious code.</p>
                <p><strong>This is the vulnerability. Never use .innerHTML with user-provided data that you do not trust completely.</strong></p>
            `;
        }
        explainerContainer.scrollIntoView({ behavior: 'smooth', block: 'end' });
    }
});
    </script>
</body>
</html>
